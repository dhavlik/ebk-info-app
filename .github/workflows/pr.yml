name: Pull Request Validation

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      checks: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Check formatting and suggest fixes
        id: format-check
        run: |
          # Check current formatting
          if ! dart format --output=none --set-exit-if-changed .; then
            echo "needs_formatting=true" >> $GITHUB_OUTPUT
            echo "üîß Formatting issues detected. Generating diff..."

            # Generate formatting diff
            dart format . > /dev/null
            git diff > format.diff

            if [ -s format.diff ]; then
              echo "Format diff generated"
              echo "diff_available=true" >> $GITHUB_OUTPUT
            else
              echo "No diff generated"
              echo "diff_available=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚úÖ Code is properly formatted"
            echo "needs_formatting=false" >> $GITHUB_OUTPUT
            echo "diff_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with formatting suggestions
        if: steps.format-check.outputs.needs_formatting == 'true' && steps.format-check.outputs.diff_available == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const diff = fs.readFileSync('format.diff', 'utf8');

              if (diff.trim()) {
                const comment = `## üé® Code Formatting Suggestions

            Your code needs some formatting adjustments. Here's what \`dart format\` would change:

            \`\`\`diff
            ${diff}
            \`\`\`

            **To fix these issues:**
            1. Run \`dart format .\` in your local repository
            2. Commit and push the changes

            Or use the pre-commit hooks to automatically format on commit:
            \`\`\`bash
            ./scripts/setup-precommit.sh
            \`\`\``;

                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            } catch (error) {
              console.log('Could not read diff file or diff is empty');
            }

      - name: Fail if formatting is needed
        if: steps.format-check.outputs.needs_formatting == 'true'
        run: |
          echo "‚ùå Code formatting is required. Please run 'dart format .' and commit the changes."
          exit 1

      - name: Analyze project source
        run: flutter analyze --fatal-infos

      - name: Run tests
        run: flutter test

      - name: Check for security vulnerabilities
        run: dart pub audit
        continue-on-error: true

  build-test:
    name: Test Build
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Test Android build
        run: flutter build apk --debug

      - name: Test Web build
        run: flutter build web --debug
