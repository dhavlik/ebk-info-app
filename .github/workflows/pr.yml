name: Pull Request Validation

on:
  pull_request:
    branches:
      - main

jobs:
  test:
    name: Test & Analyze
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
      checks: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Analyze project source
        run: flutter analyze

      - name: Run tests
        run: |
          # Run unit and widget tests, excluding integration tests for now
          flutter test --coverage \
            --exclude-tags=integration \
            --dart-define=FLUTTER_TEST_INTEGRATION_DISABLED=true

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: write
      pages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Prepare APK for upload
        run: |
          mkdir -p apk-upload
          cp build/app/outputs/flutter-apk/app-release.apk apk-upload/ebk-app-pr-${{ github.event.number }}.apk
          # Copy the index.html if it exists for a nice landing page
          if [ -f "docs/index.html" ]; then
            cp docs/index.html apk-upload/
          fi

      - name: Deploy APK to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: apk-upload
          destination_dir: apks/pr-${{ github.event.number }}
          keep_files: true

  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build Web
        run: flutter build web --release --base-href="/ebk-info-app/"

      - name: Upload Web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web/
          retention-days: 30

  comment-apk-link:
    name: Comment APK Download Link
    runs-on: ubuntu-latest
    needs: build-android
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Comment on PR with APK download link
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            const repo = context.repo;

            // Construct the GitHub Pages URL for the APK
            const apkUrl = `https://${repo.owner}.github.io/${repo.repo}/apks/pr-${prNumber}/ebk-app-pr-${prNumber}.apk`;

            const commentBody = `## ðŸ“± Android APK Ready for Testing!

            Your pull request has been built successfully! You can download and test the APK directly:

            ### ðŸ¤– Direct APK Download
            **[ðŸ“² Download APK](${apkUrl})**

            ### How to install:
            1. Click the download link above
            2. Allow downloads from unknown sources in your Android settings
            3. Install the APK file
            4. Test the changes in this PR

            **Note:** This APK will be available as long as the PR exists.

            _This comment was automatically generated by GitHub Actions._`;

            // Check if we already commented on this PR
            const { data: comments } = await github.rest.issues.listComments({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: prNumber,
            });

            const existingComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Android APK Ready for Testing!')
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: repo.owner,
                repo: repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
              console.log('âœ… Updated existing APK download comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
              console.log('âœ… Posted new APK download comment');
            }
